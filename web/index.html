<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Command Runner</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-5xl bg-white shadow-xl rounded-lg p-10">
    <h1 class="text-4xl font-bold mb-8 text-center text-gray-800">Cmd-Runner</h1>

    <!-- Step 1: Add Task -->
    <div class="mb-10">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">Step 1: Add Task</h2>
      <form id="runForm" class="space-y-6">
        <div class="flex flex-wrap gap-6">
          <!-- Agent Name 下拉选择 -->
          <div class="flex-1">
            <label class="block text-gray-600 font-medium mb-1">Agent Name</label>
            <select id="agentName" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="test">test</option>
              <option value="web">web</option>
              <option value="backend">backend</option>
            </select>
          </div>

          <div class="flex-1">
            <label class="block text-gray-600 font-medium mb-1">Command Name</label>
            <input type="text" id="runName" value="xxxxx" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="flex-1">
            <label class="block text-gray-600 font-medium mb-1">Command</label>
            <input type="text" id="cmd" value="for((i=0;i<100;i++)) do echo hello;sleep 1;done" class="w-full border border-gray-300 rounded px-6 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-8 py-3 rounded shadow">Run</button>
      </form>
      <div class="mt-2 text-gray-700">Task ID: <span id="taskId" class="font-mono text-blue-600"></span></div>
    </div>

    <!-- Step 2: Get Output -->
    <div class="mb-10">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">Step 2: Get Output</h2>
      <form id="outForm" class="flex flex-wrap gap-6 items-end">
        <div class="flex-1">
          <label class="block text-gray-600 font-medium mb-1">Task ID</label>
          <input type="text" id="outTaskId" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex-1">
          <label class="block text-gray-600 font-medium mb-1">Agent Name</label>
          <select id="outName" class="w-full border border-gray-300 rounded px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="test">test</option>
            <option value="web">web</option>
            <option value="backend">backend</option>
          </select>
        </div>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-8 py-3 rounded shadow">OutPut</button>
      </form>
    </div>

    <!-- Output -->
    <div>
      <h2 class="text-2xl font-semibold mb-2 text-gray-700">Output</h2>
      <div id="output" class="bg-black text-green-400 font-mono p-6 rounded h-96 overflow-y-scroll whitespace-pre-wrap"></div>
    </div>
  </div>

  <script>
    const outputDiv = document.getElementById("output");

    document.getElementById("runForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      outputDiv.innerHTML = "";

      const agentName = document.getElementById("agentName").value;
      const name = document.getElementById("runName").value;
      const cmd = document.getElementById("cmd").value.split(" ");

      try {
        const resp = await fetch(`/api/cmd/add?name=${agentName}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, cmd: cmd.join(" ") })
        });

        console.log("Response object:", resp);

        if (resp.status >= 200 && resp.status < 300) {
          const data = await resp.json();
          const taskId = data.task_id;
          document.getElementById("taskId").innerText = taskId;
          document.getElementById("outTaskId").value = taskId;
          outputDiv.innerHTML += "[Task started: " + taskId + "]\n";
        } else {
          const text = await resp.text();
          outputDiv.innerHTML += `[Run failed: ${resp.status} ${resp.statusText}] ${text}\n`;
        }
      } catch (err) {
        outputDiv.innerHTML += "[Fetch error: " + err.message + "]\n";
      }
    });

    document.getElementById("outForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const taskId = document.getElementById("outTaskId").value;
      const name = document.getElementById("outName").value;

      const wsUrl = `ws://${window.location.host}/api/cmd/out?task_id=${taskId}&name=${name}`;
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => { outputDiv.innerHTML += "[Connected...]\n"; };
      ws.onmessage = (event) => {
        outputDiv.innerHTML += event.data + "\n";
        outputDiv.scrollTop = outputDiv.scrollHeight;
      };
      ws.onerror = (err) => { outputDiv.innerHTML += "[Error]\n"; };
      ws.onclose = () => { outputDiv.innerHTML += "[Disconnected]\n"; };
    });
  </script>
</body>
</html>
